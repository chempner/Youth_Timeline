<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Timeline</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --salmon: #FA8072;
            --salmon-light: #FFF0EE;
            --salmon-dark: #E05A4C;
            --mint: #54B3A8;
            --mint-light: #E5F5F3;
            --mint-dark: #449E94;
            --team: #6366F1;
            --team-light: #EEF2FF;
            --team-dark: #4F46E5;
            --bg: #FAFBFC;
            --card-bg: #FFFFFF;
            --text-primary: #1A1A2E;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            --today: #3B82F6;
            --blessthun-offset: -18px;
            --youth-offset: 18px;
        }

        [data-theme="dark"] {
            --bg: #0F172A;
            --card-bg: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #334155;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            --salmon-light: rgba(250, 128, 114, 0.25);
            --mint-light: rgba(84, 179, 168, 0.25);
            --team-light: rgba(99, 102, 241, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--border);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Countdown Banner */
        .countdown-banner {
            background: linear-gradient(135deg, var(--salmon), var(--mint));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1.5rem auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            animation: fadeInUp 0.5s ease;
        }

        .countdown-banner.youth-next {
            background: linear-gradient(135deg, var(--mint), var(--mint-dark));
        }

        .countdown-banner.blessthun-next {
            background: linear-gradient(135deg, var(--salmon), var(--salmon-dark));
        }

        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .countdown-event {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.25rem 0;
        }

        .countdown-time {
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* Controls */
        .controls-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .legend {
            display: flex;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background: var(--border);
        }

        .legend-item.disabled {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.blessthun { background: var(--salmon); }
        .legend-dot.youth { background: var(--mint); }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 0.5rem 1rem 0.5rem 2rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.85rem;
            width: 160px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--salmon);
            width: 200px;
        }

        .search-icon {
            position: absolute;
            left: 0.6rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 14px;
            height: 14px;
        }

        .year-picker {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .year-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 80px;
            appearance: auto;
            -webkit-appearance: auto;
        }

        .btn {
            background: #1E293B;
            color: white;
            border: none;
            padding: 0.5rem 0.9rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: #059669; }
        .btn-success:hover { background: #047857; }

        .btn-icon {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            width: 34px;
            height: 34px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .btn-icon:hover {
            background: var(--border);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #D1D5DB;
            display: inline-block;
            margin-right: 0.25rem;
        }

        .status-dot.loaded { background: #10B981; }
        .status-dot.error { background: #EF4444; }

        /* Timeline */
        .timeline-section {
            margin-bottom: 2rem;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }

        .pdf-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pdf-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .pdf-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .timeline-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.5s ease;
            transition: all 0.3s ease;
        }

        .timeline-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .timeline-scroll-container::-webkit-scrollbar {
            height: 6px;
        }

        .timeline-scroll-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .timeline-content {
            min-width: 1000px;
        }

        @media (max-width: 700px) {
            .timeline-card { padding: 1rem; }
            .timeline-content { min-width: 900px; }
            .container { padding: 1rem; }
            body { padding: 1rem; }
            h1 { font-size: 1.8rem; }
            .controls-bar { gap: 0.5rem; }
            .search-input { width: 120px; }
            .search-input:focus { width: 150px; }
        }

        .timeline-header {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .year-badge {
            background: linear-gradient(135deg, var(--text-primary), #374151);
            color: white;
            padding: 0.4rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
        }

        [data-theme="dark"] .year-badge {
            background: linear-gradient(135deg, #475569, #334155);
        }

        .timeline-wrapper {
            position: relative;
            padding: 100px 0;
        }

        /* Holiday strips on the timeline */
        .holidays-container {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .holiday-strip {
            position: absolute;
            height: 18px;
            background: linear-gradient(135deg, #A78BFA, #8B5CF6);
            border-radius: 3px;
            z-index: 5;
            pointer-events: auto;
            cursor: default;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            overflow: visible;
            top: 2px;
            transform: translateY(-9px);
        }

        .holiday-strip.row-1 { transform: translateY(-31px); }
        .holiday-strip.row-2 { transform: translateY(-53px); }
        .holiday-strip.row-3 { transform: translateY(-75px); }

        .holiday-strip-label {
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5), 0 0 2px rgba(0,0,0,0.3);
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            letter-spacing: 0.02em;
        }

        .holiday-strip-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            margin-bottom: 4px;
            z-index: 1000;
            text-align: center;
        }

        .holiday-strip-tooltip .tooltip-dates {
            font-size: 0.6rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .holiday-strip:hover {
            z-index: 10;
        }

        .holiday-strip:hover .holiday-strip-tooltip {
            opacity: 0;
            visibility: visible;
        }

        [data-theme="dark"] .holiday-strip {
            background: linear-gradient(135deg, #A78BFA, #8B5CF6);
        }

        .holiday-strip.past {
            opacity: 0.4;
        }

        .timeline-track {
            position: relative;
            margin: 0 30px;
        }

        .timeline-line {
            height: 4px;
            background: linear-gradient(90deg, var(--salmon), var(--mint));
            border-radius: 2px;
            position: relative;
        }

        .timeline-dot-start, .timeline-dot-end {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .timeline-dot-start {
            left: -5px;
            background: var(--salmon);
        }

        .timeline-dot-end {
            right: -5px;
            background: var(--mint);
        }

        .timeline-empty {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem;
        }

        /* Today Marker */
        .today-marker {
            position: absolute;
            top: -25px;
            bottom: -25px;
            width: 2px;
            background: var(--today);
            z-index: 20;
            transform: translateX(-50%);
        }

        .today-marker::before {
            content: 'TODAY';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--today);
            color: white;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .today-marker::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--today);
            border-radius: 50%;
        }

        /* Month Markers */
        .month-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
        }

        .month-marker {
            position: absolute;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            top: 100%;
            margin-top: 6px;
        }

        .month-marker-line {
            width: 1px;
            height: 10px;
            background: var(--border);
        }

        .month-marker-label {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 3px;
        }

        /* Events */
        .events-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
        }

        .event-marker {
            position: absolute;
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s ease;
        }

        .event-marker:hover {
            transform: translateX(-50%) scale(1.2);
            z-index: 100;
        }

        .event-marker.blessthun {
            top: 2px;
            transform: translate(-50%, calc(var(--blessthun-offset) - 7px));
        }

        .event-marker.blessthun:hover {
            transform: translate(-50%, calc(var(--blessthun-offset) - 7px)) scale(1.2);
        }

        .event-marker.youth {
            top: 2px;
            transform: translate(-50%, calc(var(--youth-offset) - 7px));
        }

        .event-marker.youth:hover {
            transform: translate(-50%, calc(var(--youth-offset) - 7px)) scale(1.2);
        }

        /* Vertical offsets for multiple different events on same day */
        .event-marker.blessthun.v-offset-1 { transform: translate(-50%, calc(var(--blessthun-offset) - 7px - 18px)); }
        .event-marker.blessthun.v-offset-2 { transform: translate(-50%, calc(var(--blessthun-offset) - 7px - 36px)); }
        .event-marker.blessthun.v-offset-3 { transform: translate(-50%, calc(var(--blessthun-offset) - 7px - 54px)); }
        .event-marker.youth.v-offset-1 { transform: translate(-50%, calc(var(--youth-offset) - 7px + 18px)); }
        .event-marker.youth.v-offset-2 { transform: translate(-50%, calc(var(--youth-offset) - 7px + 36px)); }
        .event-marker.youth.v-offset-3 { transform: translate(-50%, calc(var(--youth-offset) - 7px + 54px)); }

        .event-marker.blessthun.v-offset-1:hover { transform: translate(-50%, calc(var(--blessthun-offset) - 7px - 18px)) scale(1.2); }
        .event-marker.blessthun.v-offset-2:hover { transform: translate(-50%, calc(var(--blessthun-offset) - 7px - 36px)) scale(1.2); }
        .event-marker.blessthun.v-offset-3:hover { transform: translate(-50%, calc(var(--blessthun-offset) - 7px - 54px)) scale(1.2); }
        .event-marker.youth.v-offset-1:hover { transform: translate(-50%, calc(var(--youth-offset) - 7px + 18px)) scale(1.2); }
        .event-marker.youth.v-offset-2:hover { transform: translate(-50%, calc(var(--youth-offset) - 7px + 36px)) scale(1.2); }
        .event-marker.youth.v-offset-3:hover { transform: translate(-50%, calc(var(--youth-offset) - 7px + 54px)) scale(1.2); }

        .event-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            position: relative;
        }

        .event-dot.blessthun { background: var(--salmon); }
        .event-dot.youth { background: var(--mint); }

        .event-count-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--text-primary);
            color: white;
            font-size: 9px;
            font-weight: 700;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
        }

        [data-theme="dark"] .event-count-badge {
            background: #F1F5F9;
            color: #1E293B;
        }

        .event-tooltip {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .event-marker.blessthun .event-tooltip { bottom: 100%; margin-bottom: 6px; }
        .event-marker.youth .event-tooltip { top: 100%; margin-top: 6px; }
        .event-marker:hover .event-tooltip { opacity: 1; }

        /* Edge tooltip positioning - align to left/right instead of center */
        .event-marker.tooltip-right .event-tooltip,
        .secondary-event.tooltip-right .event-tooltip {
            left: 0;
            transform: none;
        }
        .event-marker.tooltip-left .event-tooltip,
        .secondary-event.tooltip-left .event-tooltip {
            left: auto;
            right: 0;
            transform: none;
        }

        /* Secondary Events */
        .secondary-event {
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            z-index: 8;
            transition: transform 0.2s ease;
        }

        .secondary-event:hover {
            z-index: 100;
        }

        .secondary-event.blessthun {
            top: 2px;
            transform: translate(-50%, calc(var(--blessthun-offset) - 4px));
        }

        .secondary-event.blessthun:hover {
            transform: translate(-50%, calc(var(--blessthun-offset) - 4px)) scale(1.3);
        }

        .secondary-event.youth {
            top: 2px;
            transform: translate(-50%, calc(var(--youth-offset) - 4px));
        }

        .secondary-event.youth:hover {
            transform: translate(-50%, calc(var(--youth-offset) - 4px)) scale(1.3);
        }

        /* Vertical offsets for multiple different secondary events on same day */
        .secondary-event.blessthun.v-offset-1 { transform: translate(-50%, calc(var(--blessthun-offset) - 4px - 12px)); }
        .secondary-event.blessthun.v-offset-2 { transform: translate(-50%, calc(var(--blessthun-offset) - 4px - 24px)); }
        .secondary-event.blessthun.v-offset-3 { transform: translate(-50%, calc(var(--blessthun-offset) - 4px - 36px)); }
        .secondary-event.youth.v-offset-1 { transform: translate(-50%, calc(var(--youth-offset) - 4px + 12px)); }
        .secondary-event.youth.v-offset-2 { transform: translate(-50%, calc(var(--youth-offset) - 4px + 24px)); }
        .secondary-event.youth.v-offset-3 { transform: translate(-50%, calc(var(--youth-offset) - 4px + 36px)); }
        
        .secondary-event.blessthun.v-offset-1:hover { transform: translate(-50%, calc(var(--blessthun-offset) - 4px - 12px)) scale(1.3); }
        .secondary-event.blessthun.v-offset-2:hover { transform: translate(-50%, calc(var(--blessthun-offset) - 4px - 24px)) scale(1.3); }
        .secondary-event.blessthun.v-offset-3:hover { transform: translate(-50%, calc(var(--blessthun-offset) - 4px - 36px)) scale(1.3); }
        .secondary-event.youth.v-offset-1:hover { transform: translate(-50%, calc(var(--youth-offset) - 4px + 12px)) scale(1.3); }
        .secondary-event.youth.v-offset-2:hover { transform: translate(-50%, calc(var(--youth-offset) - 4px + 24px)) scale(1.3); }
        .secondary-event.youth.v-offset-3:hover { transform: translate(-50%, calc(var(--youth-offset) - 4px + 36px)) scale(1.3); }

        .event-square {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            opacity: 0.7;
        }

        .event-square.blessthun { background: var(--salmon); }
        .event-square.youth { background: var(--mint); }

        .secondary-event .event-tooltip {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .secondary-event.blessthun .event-tooltip { bottom: 100%; margin-bottom: 6px; }
        .secondary-event.youth .event-tooltip { top: 100%; margin-top: 6px; }
        .secondary-event:hover .event-tooltip { opacity: 1; }

        /* Multi-day */
        .multiday-pill {
            position: absolute;
            height: 8px;
            border-radius: 4px;
            z-index: 11;
            pointer-events: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        .multiday-pill.blessthun {
            background: var(--salmon);
            top: 2px;
            transform: translateY(calc(var(--blessthun-offset) - 4px));
        }

        .multiday-pill.youth {
            background: var(--mint);
            top: 2px;
            transform: translateY(calc(var(--youth-offset) - 4px));
        }

        .multiday-label {
            position: absolute;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            cursor: pointer;
            z-index: 15;
            transition: transform 0.2s ease;
        }

        .multiday-label:hover {
            z-index: 100;
        }

        .multiday-label.blessthun-type {
            top: 2px;
            transform: translateX(-50%) translateY(calc(var(--blessthun-offset) - 4px - 100%));
        }

        .multiday-label.blessthun-type:hover {
            transform: translateX(-50%) translateY(calc(var(--blessthun-offset) - 4px - 100%)) scale(1.05);
        }

        .multiday-label.youth-type {
            top: 2px;
            transform: translateX(-50%) translateY(calc(var(--youth-offset) - 4px));
            flex-direction: column-reverse;
        }

        .multiday-label.youth-type:hover {
            transform: translateX(-50%) translateY(calc(var(--youth-offset) - 4px)) scale(1.05);
        }

        .multiday-label .event-connector {
            width: 2px;
            height: 22px;
            flex-shrink: 0;
        }

        .multiday-label.blessthun-type .event-connector { background: var(--salmon); }
        .multiday-label.youth-type .event-connector { background: var(--mint); }

        .multiday-label .event-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 8px;
            border-radius: 6px;
            max-width: 110px;
            transition: all 0.2s ease;
        }

        .multiday-label.blessthun-type .event-label {
            background: var(--salmon-light);
            border-left: 3px solid var(--salmon);
        }

        .multiday-label.youth-type .event-label {
            background: var(--mint-light);
            border-left: 3px solid var(--mint);
        }

        .multiday-label .event-month {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .multiday-label.blessthun-type .event-month { color: var(--salmon-dark); }
        .multiday-label.youth-type .event-month { color: var(--mint-dark); }

        .multiday-label .event-name {
            font-size: 0.65rem;
            font-weight: 500;
            color: #1A1A2E;
            text-align: center;
            word-wrap: break-word;
            max-width: 95px;
        }

        [data-theme="dark"] .multiday-label .event-name {
            color: #F1F5F9;
        }

        .multiday-label:hover .event-label {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .multiday-label.blessthun-type.offset-1 .event-connector { height: 50px; }
        .multiday-label.blessthun-type.offset-2 .event-connector { height: 78px; }
        .multiday-label.youth-type.offset-1 .event-connector { height: 50px; }
        .multiday-label.youth-type.offset-2 .event-connector { height: 78px; }

        /* Lists */
        .lists-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 700px) {
            .lists-wrapper { grid-template-columns: 1fr; }
        }

        .list-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeInUp 0.5s ease;
            transition: all 0.3s ease;
        }

        .list-card.blessthun { border-top: 4px solid var(--salmon); }
        .list-card.youth { border-top: 4px solid var(--mint); }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .list-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .event-count {
            background: var(--border);
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .events-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .events-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.4rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 4px;
            margin: 0 -0.4rem;
        }

        .events-list-item:hover { background: var(--border); }
        .events-list-item:last-child { border-bottom: none; }

        .events-list-name {
            font-weight: 500;
            font-size: 0.85rem;
        }

        .events-list-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .events-list-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 1rem;
            font-size: 0.85rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .modal-badge.blessthun {
            background: var(--salmon-light);
            color: var(--salmon-dark);
        }

        .modal-badge.youth {
            background: var(--mint-light);
            color: var(--mint-dark);
        }

        .modal-date {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .modal-time {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .modal-location {
            display: flex;
            align-items: flex-start;
            gap: 0.4rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .modal-location svg {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .modal-same-day {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .same-day-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .same-day-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .same-day-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .same-day-item:hover {
            background: var(--border);
        }

        .same-day-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .same-day-dot.blessthun { background: var(--salmon); }
        .same-day-dot.youth { background: var(--mint); }

        .same-day-name {
            flex: 1;
        }

        .same-day-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .modal-actions .btn {
            flex: 1;
            justify-content: center;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #1E293B;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            font-size: 0.85rem;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { background: #059669; }
        .toast.error { background: #DC2626; }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spin { animation: spin 1s linear infinite; }

        /* Notification prompt */
        .notification-prompt {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin: 1rem auto;
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            animation: fadeInUp 0.5s ease;
            font-size: 0.85rem;
        }

        .notification-prompt.hidden { display: none; }

        /* PDF Dropdown */
        .pdf-dropdown {
            position: relative;
        }

        .pdf-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 100;
            overflow: hidden;
        }

        .pdf-menu.show {
            display: block;
        }

        .pdf-menu button {
            display: block;
            width: 100%;
            padding: 0.6rem 1rem;
            border: none;
            background: none;
            color: var(--text-primary);
            font-size: 0.85rem;
            text-align: left;
            cursor: pointer;
            white-space: nowrap;
        }

        .pdf-menu button:hover {
            background: var(--border);
        }

        /* Progress Bar */
        .progress-section {
            margin: 1rem 0;
        }

        .progress-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .progress-info {
            flex: 1;
            min-width: 200px;
        }

        .progress-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--salmon), var(--mint));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        .jump-today-btn {
            background: var(--today);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }

        .jump-today-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }

        /* Stats Card */
        .stats-section {
            margin: 1.5rem 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.blessthun { color: var(--salmon); }
        .stat-value.youth { color: var(--mint); }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        /* Share Modal */
        .share-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            z-index: 100;
            padding: 1rem;
            min-width: 200px;
        }

        .share-menu.show {
            display: block;
        }

        .share-menu h4 {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .share-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .share-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .share-btn:hover {
            background: var(--border);
        }

        .qr-container {
            text-align: center;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .qr-container canvas {
            border-radius: 8px;
        }

        .qr-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }

        /* Past Events Faded */
        .event-marker.past,
        .secondary-event.past,
        .multiday-label.past {
            opacity: 0.4;
        }

        .event-marker.past:hover,
        .secondary-event.past:hover,
        .multiday-label.past:hover {
            opacity: 0.8;
        }

        .multiday-pill.past {
            opacity: 0.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-links">
            <a href="/" class="nav-link active">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/>
                </svg>
                Timeline
            </a>
            <a href="/overview" class="nav-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Yearly Overview
            </a>
        </div>

        <header>
            <h1>Event Timeline</h1>
            <p class="subtitle">Two-Year Overview</p>
            
            <div id="countdown-banner" class="countdown-banner" style="display: none;">
                <div class="countdown-label">Next Event</div>
                <div class="countdown-event" id="countdown-event"></div>
                <div class="countdown-time" id="countdown-time"></div>
            </div>
        </header>

        <div id="notification-prompt" class="notification-prompt hidden">
            <span>ðŸ”” Get notified before events?</span>
            <div style="display: flex; gap: 0.4rem;">
                <button class="btn" onclick="requestNotifications()">Enable</button>
                <button class="btn-icon" onclick="dismissNotifications()">âœ•</button>
            </div>
        </div>

        <div class="controls-bar">
            <div class="legend">
                <div class="legend-item" id="filter-blessthun" onclick="toggleFilter('blessthun')">
                    <div class="legend-dot blessthun"></div>
                    <span>BlessThun</span>
                </div>
                <div class="legend-item" id="filter-youth" onclick="toggleFilter('youth')">
                    <div class="legend-dot youth"></div>
                    <span>Youth Revival</span>
                </div>
            </div>

            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" placeholder="Search..." oninput="handleSearch(this.value)">
            </div>

            <div class="year-picker">
                <select class="year-select" id="year1-select" onchange="changeYear(1, this.value)"></select>
                <span style="color: var(--text-secondary);">&</span>
                <select class="year-select" id="year2-select" onchange="changeYear(2, this.value)"></select>
            </div>

            <button class="btn" id="resync-btn" onclick="manualResync()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Sync
            </button>

            <div class="pdf-dropdown">
                <button class="btn btn-success" onclick="togglePdfMenu()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    PDF
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9"/>
                    </svg>
                </button>
                <div class="pdf-menu" id="pdf-menu">
                    <button onclick="downloadPDF('a4')">A4 Landscape</button>
                    <button onclick="downloadPDF('a3')">A3 Landscape</button>
                </div>
            </div>

            <button class="btn-icon" onclick="toggleDarkMode()" title="Toggle dark mode">
                <svg id="theme-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </button>

            <button class="btn-icon" onclick="toggleLanguage()" title="Sprache / Language">
                <span id="lang-icon" style="font-size: 14px; font-weight: 600;">DE</span>
            </button>

            <div class="pdf-dropdown">
                <button class="btn-icon" onclick="toggleShareMenu()" title="Share">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                </button>
                <div class="share-menu" id="share-menu">
                    <h4>Share</h4>
                    <div class="share-buttons">
                        <button class="share-btn" onclick="copyLink()" title="Copy link">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                            </svg>
                        </button>
                        <button class="share-btn" onclick="shareWhatsApp()" title="WhatsApp">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                        </button>
                        <button class="share-btn" onclick="shareTelegram()" title="Telegram">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="qr-container">
                        <canvas id="qr-canvas" width="120" height="120"></canvas>
                        <div class="qr-label">Scan to open</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span><span class="status-dot" id="blessthun-status"></span>BlessThun</span>
            <span><span class="status-dot" id="youth-status"></span>Youth Revival</span>
            <span id="last-sync"></span>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section">
            <div class="progress-card">
                <div class="progress-info">
                    <div class="progress-label" id="progress-label">Year Progress</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0% of 2026</div>
                </div>
                <button class="jump-today-btn" onclick="jumpToToday()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/>
                    </svg>
                    Jump to Today
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value blessthun" id="stat-blessthun">0</div>
                    <div class="stat-label">BlessThun Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value youth" id="stat-youth">0</div>
                    <div class="stat-label">Youth Revival Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-upcoming">0</div>
                    <div class="stat-label">Upcoming</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-busiest">-</div>
                    <div class="stat-label">Busiest Month</div>
                </div>
            </div>
        </div>

        <div class="timeline-section" id="timeline-section">
            <div class="pdf-header">
                <h2 class="pdf-title">Event Timeline</h2>
                <div class="pdf-legend">
                    <span class="pdf-legend-item"><span class="legend-dot blessthun"></span> BlessThun</span>
                    <span class="pdf-legend-item"><span class="legend-dot youth"></span> Youth Revival</span>
                </div>
            </div>
            
            <div class="timeline-card">
                <div class="timeline-header">
                    <span class="year-badge" id="year1-badge">2026</span>
                </div>
                <div class="timeline-scroll-container">
                    <div class="timeline-content">
                        <div class="timeline-wrapper">
                            <div class="timeline-track">
                                <div class="holidays-container" id="holidays-1"></div>
                                <div class="timeline-line">
                                    <div class="timeline-dot-start"></div>
                                    <div class="timeline-dot-end"></div>
                                </div>
                                <div class="month-markers" id="timeline1-months"></div>
                                <div class="events-container" id="timeline1-events"></div>
                            </div>
                            <div class="timeline-empty" id="timeline1-empty">No events for this year</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="timeline-card">
                <div class="timeline-header">
                    <span class="year-badge" id="year2-badge">2027</span>
                </div>
                <div class="timeline-scroll-container">
                    <div class="timeline-content">
                        <div class="timeline-wrapper">
                            <div class="timeline-track">
                                <div class="holidays-container" id="holidays-2"></div>
                                <div class="timeline-line">
                                    <div class="timeline-dot-start"></div>
                                    <div class="timeline-dot-end"></div>
                                </div>
                                <div class="month-markers" id="timeline2-months"></div>
                                <div class="events-container" id="timeline2-events"></div>
                            </div>
                            <div class="timeline-empty" id="timeline2-empty">No events for this year</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lists-wrapper">
            <div class="list-card blessthun">
                <div class="list-header">
                    <h3 class="list-title">BlessThun Events</h3>
                    <span class="event-count" id="blessthun-count">0 events</span>
                </div>
                <div class="events-list" id="blessthun-list">
                    <div class="events-list-empty">Loading...</div>
                </div>
            </div>

            <div class="list-card youth">
                <div class="list-header">
                    <h3 class="list-title">Youth Revival Events</h3>
                    <span class="event-count" id="youth-count">0 events</span>
                </div>
                <div class="events-list" id="youth-list">
                    <div class="events-list-empty">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="event-modal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Event Name</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <span class="modal-badge" id="modal-badge">BlessThun</span>
            <div class="modal-date" id="modal-date">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span id="modal-date-text">January 15, 2026</span>
            </div>
            <div class="modal-time" id="modal-time" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/>
                </svg>
                <span id="modal-time-text">19:00 - 23:00</span>
            </div>
            <div class="modal-location" id="modal-location" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="modal-location-text"></span>
            </div>
            <div class="modal-same-day" id="modal-same-day" style="display: none;">
                <div class="same-day-label">Also on this day:</div>
                <div class="same-day-list" id="same-day-list"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="addToCalendar()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Add to Calendar
                </button>
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const MIN_YEAR = 2026;
        const YEAR_RANGE = [2025, 2026, 2027, 2028, 2029, 2030];
        const PRIMARY_EVENTS = { 'blessthun': 'BlessThun', 'youth': 'Youth Revival' };
        
        const translations = {
            en: {
                months: ['January','February','March','April','May','June','July','August','September','October','November','December'],
                monthsShort: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                timeline: 'Timeline',
                yearlyOverview: 'Yearly Overview',
                eventTimeline: 'Event Timeline',
                twoYearOverview: 'Two-Year Overview',
                nextEvent: 'Next Event',
                inDays: 'In {n} days',
                tomorrow: 'Tomorrow',
                today: 'Today',
                search: 'Search...',
                sync: 'Sync',
                pdf: 'PDF',
                a4Landscape: 'A4 Landscape',
                a3Landscape: 'A3 Landscape',
                share: 'Share',
                scanToOpen: 'Scan to open',
                yearProgress: 'Year Progress',
                jumpToToday: 'Jump to Today',
                blessthunEvents: 'BlessThun Events',
                youthEvents: 'Youth Revival Events',
                upcoming: 'Upcoming',
                busiestMonth: 'Busiest Month',
                noEvents: 'No events for this year',
                events: 'events',
                loading: 'Loading...',
                addToCalendar: 'Add to Calendar',
                close: 'Close',
                alsoOnThisDay: 'Also on this day:',
                synced: 'Synced',
                neverSynced: 'Never synced',
                enableNotifications: 'Get notified before events?',
                enable: 'Enable',
                linkCopied: 'Link copied!',
                eventDownloaded: 'Event downloaded!',
                generating: 'Generating...',
                downloadComplete: 'Download complete!',
                jumpedToToday: 'Jumped to today!'
            },
            de: {
                months: ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'],
                monthsShort: ['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'],
                timeline: 'Timeline',
                yearlyOverview: 'TabellenÃ¼bersicht',
                eventTimeline: 'Event Timeline',
                twoYearOverview: 'Zwei-Jahres-Ãœbersicht',
                nextEvent: 'NÃ¤chstes Event',
                inDays: 'In {n} Tagen',
                tomorrow: 'Morgen',
                today: 'Heute',
                search: 'Suchen...',
                sync: 'Sync',
                pdf: 'PDF',
                a4Landscape: 'A4 Querformat',
                a3Landscape: 'A3 Querformat',
                share: 'Teilen',
                scanToOpen: 'Scannen zum Ã–ffnen',
                yearProgress: 'Jahresfortschritt',
                jumpToToday: 'Zu Heute springen',
                blessthunEvents: 'BlessThun Events',
                youthEvents: 'Youth Revival Events',
                upcoming: 'Bevorstehend',
                busiestMonth: 'Meiste Events',
                noEvents: 'Keine Events fÃ¼r dieses Jahr',
                events: 'Events',
                loading: 'Laden...',
                addToCalendar: 'Zum Kalender hinzufÃ¼gen',
                close: 'Schliessen',
                alsoOnThisDay: 'Auch an diesem Tag:',
                synced: 'Synchronisiert',
                neverSynced: 'Nie synchronisiert',
                enableNotifications: 'Benachrichtigungen aktivieren?',
                enable: 'Aktivieren',
                linkCopied: 'Link kopiert!',
                eventDownloaded: 'Event heruntergeladen!',
                generating: 'Erstelle...',
                downloadComplete: 'Download fertig!',
                jumpedToToday: 'Zu heute gesprungen!'
            }
        };

        let events = { blessthun: [], youth: [] };
        let holidays = [];
        let currentYear1 = new Date().getFullYear();
        let currentYear2 = currentYear1 + 1;
        let filters = { blessthun: true, youth: true };
        let searchQuery = '';
        let currentModalEvent = null;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let currentLang = localStorage.getItem('language') || 'en';

        // Get current translation
        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        // Get month names for current language
        function getMonthNames() {
            return translations[currentLang].months;
        }
        function getMonthShort() {
            return translations[currentLang].monthsShort;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initYearPickers();
            loadData();
            updateStatus();
            initDarkMode();
            initLanguage();
            checkNotificationPermission();
            setInterval(updateCountdown, 60000);
        });

        function initLanguage() {
            applyTranslations();
            updateLangIcon();
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'de' : 'en';
            localStorage.setItem('language', currentLang);
            applyTranslations();
            updateLangIcon();
            renderAllTimelines();
            updateStats();
            updateCountdown();
        }

        function updateLangIcon() {
            document.getElementById('lang-icon').textContent = currentLang === 'en' ? 'DE' : 'EN';
        }

        function applyTranslations() {
            // Nav
            document.querySelector('a[href="/overview"]').innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                ${t('yearlyOverview')}`;
            
            // Header
            document.querySelector('header h1').textContent = t('eventTimeline');
            document.querySelector('header .subtitle').textContent = t('twoYearOverview');
            document.querySelector('.countdown-label').textContent = t('nextEvent');
            
            // Notification prompt
            document.querySelector('#notification-prompt span').textContent = 'ðŸ”” ' + t('enableNotifications');
            document.querySelector('#notification-prompt .btn').textContent = t('enable');
            
            // Search
            document.querySelector('.search-input').placeholder = t('search');
            
            // Buttons
            document.querySelector('#resync-btn').innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                ${t('sync')}`;
            
            // PDF menu
            const pdfMenu = document.getElementById('pdf-menu');
            if (pdfMenu) {
                pdfMenu.innerHTML = `
                    <button onclick="downloadPDF('a4')">${t('a4Landscape')}</button>
                    <button onclick="downloadPDF('a3')">${t('a3Landscape')}</button>`;
            }
            
            // Share
            const shareMenu = document.getElementById('share-menu');
            if (shareMenu) {
                shareMenu.querySelector('h4').textContent = t('share');
                shareMenu.querySelector('.qr-label').textContent = t('scanToOpen');
            }
            
            // Progress section
            document.getElementById('progress-label').textContent = t('yearProgress');
            document.querySelector('.jump-today-btn').innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/>
                </svg>
                ${t('jumpToToday')}`;
            
            // Stats
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels.length >= 4) {
                statLabels[0].textContent = t('blessthunEvents');
                statLabels[1].textContent = t('youthEvents');
                statLabels[2].textContent = t('upcoming');
                statLabels[3].textContent = t('busiestMonth');
            }
            
            // Timeline empty states
            document.getElementById('timeline1-empty').textContent = t('noEvents');
            document.getElementById('timeline2-empty').textContent = t('noEvents');
            
            // List headers
            document.querySelectorAll('.list-title')[0].textContent = t('blessthunEvents');
            document.querySelectorAll('.list-title')[1].textContent = t('youthEvents');
            
            // Modal
            document.querySelector('.same-day-label').textContent = t('alsoOnThisDay');
            document.querySelector('.modal-actions .btn-success').innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ${t('addToCalendar')}`;
            document.querySelector('.modal-actions .btn:not(.btn-success)').textContent = t('close');
        }

        function initDarkMode() {
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : '');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            icon.innerHTML = darkMode 
                ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>'
                : '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
        }

        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default' && !localStorage.getItem('notificationsDismissed')) {
                document.getElementById('notification-prompt').classList.remove('hidden');
            }
        }

        function requestNotifications() {
            Notification.requestPermission().then(p => {
                document.getElementById('notification-prompt').classList.add('hidden');
                if (p === 'granted') showToast('Notifications enabled!', 'success');
            });
        }

        function dismissNotifications() {
            localStorage.setItem('notificationsDismissed', 'true');
            document.getElementById('notification-prompt').classList.add('hidden');
        }

        function initYearPickers() {
            const s1 = document.getElementById('year1-select');
            const s2 = document.getElementById('year2-select');
            if (!s1 || !s2) return;
            
            s1.innerHTML = '';
            s2.innerHTML = '';
            
            for (let i = 0; i < YEAR_RANGE.length; i++) {
                const y = YEAR_RANGE[i];
                const opt1 = document.createElement('option');
                opt1.value = y;
                opt1.textContent = y;
                if (y === currentYear1) opt1.selected = true;
                s1.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = y;
                opt2.textContent = y;
                if (y === currentYear2) opt2.selected = true;
                s2.appendChild(opt2);
            }
        }

        function changeYear(t, y) {
            y = parseInt(y);
            if (t===1) { currentYear1=y; document.getElementById('year1-badge').textContent=y; }
            else { currentYear2=y; document.getElementById('year2-badge').textContent=y; }
            renderAllTimelines();
            renderEventsList('blessthun');
            renderEventsList('youth');
            updateStats();
        }

        function toggleFilter(type) {
            filters[type] = !filters[type];
            document.getElementById(`filter-${type}`).classList.toggle('disabled', !filters[type]);
            renderAllTimelines();
            renderEventsList('blessthun');
            renderEventsList('youth');
        }

        function handleSearch(q) {
            searchQuery = q.toLowerCase();
            renderAllTimelines();
            renderEventsList('blessthun');
            renderEventsList('youth');
        }

        function matchesSearch(e) { return !searchQuery || e.name.toLowerCase().includes(searchQuery); }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function updateCountdown() {
            const all = [...getAllEvents('blessthun'), ...getAllEvents('youth')];
            const now = new Date();
            const upcoming = all.filter(e => new Date(e.startDate+'T00:00:00') > now).sort((a,b) => a.startDate.localeCompare(b.startDate))[0];
            const banner = document.getElementById('countdown-banner');
            
            if (!upcoming) { banner.style.display = 'none'; return; }
            
            const eventDate = new Date(upcoming.startDate+'T00:00:00');
            const diffDays = Math.ceil((eventDate - now) / (1000*60*60*24));
            
            banner.style.display = 'block';
            banner.className = `countdown-banner ${upcoming.type}-next`;
            document.getElementById('countdown-event').textContent = upcoming.name;
            
            let timeText;
            if (diffDays === 0) timeText = t('today') + '!';
            else if (diffDays === 1) timeText = t('tomorrow') + '!';
            else timeText = t('inDays').replace('{n}', diffDays);
            document.getElementById('countdown-time').textContent = timeText;
        }

        function parseICalDate(s) {
            if (!s) return null;
            if (s.length === 8) return new Date(parseInt(s.slice(0,4)), parseInt(s.slice(4,6))-1, parseInt(s.slice(6,8)), 12);
            if (s.includes('T')) {
                const isUTC = s.endsWith('Z');
                const c = s.replace('Z','');
                const d = new Date(parseInt(c.slice(0,4)), parseInt(c.slice(4,6))-1, parseInt(c.slice(6,8)), parseInt(c.slice(9,11))||0, parseInt(c.slice(11,13))||0);
                if (isUTC) return new Date(new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes())).toLocaleString('en-US',{timeZone:'Europe/Zurich'}));
                return d;
            }
            return new Date(s);
        }

        function formatDateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function formatTimeStr(d) { return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

        function parseIcal(data) {
            const evts = [], lines = data.split(/\r?\n/);
            let cur = null;
            for (let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                while (i+1<lines.length && (lines[i+1].startsWith(' ')||lines[i+1].startsWith('\t'))) { i++; line += lines[i].slice(1); }
                if (line === 'BEGIN:VEVENT') cur = { _startDt: null, _endDt: null };
                else if (line === 'END:VEVENT' && cur) {
                    if (cur.startDate && cur.name) {
                        let end = cur.endDate || cur.startDate;
                        if (cur.endIsAllDay && end !== cur.startDate) {
                            const ed = new Date(end+'T12:00:00'); ed.setDate(ed.getDate()-1); end = formatDateStr(ed);
                        }
                        
                        // Check if it's an overnight event (â‰¤12 hours but spans 2 calendar days)
                        let isOvernight = false;
                        let isMultiDay = end !== cur.startDate;
                        
                        if (isMultiDay && cur._startDt && cur._endDt && !cur.startIsAllDay) {
                            const durationHours = (cur._endDt - cur._startDt) / (1000 * 60 * 60);
                            if (durationHours <= 12) {
                                isOvernight = true;
                                isMultiDay = false; // Don't show as pill
                            }
                        }
                        
                        evts.push({ 
                            id: Date.now()+Math.random(), 
                            date: cur.startDate, 
                            startDate: cur.startDate, 
                            endDate: end, 
                            name: cur.name, 
                            isMultiDay: isMultiDay,
                            isOvernight: isOvernight,
                            startTime: cur.startTime,
                            endTime: cur.endTime,
                            isAllDay: cur.startIsAllDay,
                            location: cur.location
                        });
                    }
                    cur = null;
                } else if (cur) {
                    const ci = line.indexOf(':');
                    if (ci > 0) {
                        const key = line.slice(0,ci), val = line.slice(ci+1);
                        const isDateOnly = key.includes('VALUE=DATE') && !key.includes('DATE-TIME');
                        if (key.startsWith('DTSTART')) { 
                            const p = parseICalDate(val); 
                            if(p) { 
                                cur.startDate = formatDateStr(p); 
                                cur.startIsAllDay = isDateOnly || val.length===8;
                                if (!cur.startIsAllDay) cur.startTime = formatTimeStr(p);
                                cur._startDt = p;
                            } 
                        }
                        else if (key.startsWith('DTEND')) { 
                            const p = parseICalDate(val); 
                            if(p) { 
                                cur.endDate = formatDateStr(p); 
                                cur.endIsAllDay = isDateOnly || val.length===8;
                                if (!cur.endIsAllDay) cur.endTime = formatTimeStr(p);
                                cur._endDt = p;
                            } 
                        }
                        else if (key === 'SUMMARY') cur.name = val;
                        else if (key === 'LOCATION') cur.location = val.replace(/\\,/g, ',').replace(/\\;/g, ';');
                    }
                }
            }
            return evts;
        }

        async function fetchCalendar(type) {
            const status = document.getElementById(`${type}-status`);
            try {
                const res = await fetch(`/calendars/${type}.ics?t=${Date.now()}`);
                if (!res.ok) throw new Error();
                const data = await res.text();
                if (!data.includes('BEGIN:VCALENDAR')) throw new Error();
                events[type] = parseIcal(data);
                status.classList.add('loaded'); status.classList.remove('error');
                return true;
            } catch { status.classList.add('error'); status.classList.remove('loaded'); events[type] = []; return false; }
        }

        async function manualResync() {
            const btn = document.getElementById('resync-btn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>';
            try {
                const res = await fetch('/api/resync', { method: 'POST' });
                const r = await res.json();
                if (r.success) {
                    showToast(t('synced') + '!', 'success');
                    await loadData();
                    await updateStatus();
                } else {
                    showToast('Sync failed', 'error');
                }
            } catch (e) { showToast('Sync failed', 'error'); }
            btn.disabled = false;
            btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> ${t('sync')}`;
        }

        function togglePdfMenu() {
            document.getElementById('pdf-menu').classList.toggle('show');
        }

        async function downloadPDF(format = 'a3') {
            document.getElementById('pdf-menu').classList.remove('show');
            showToast(t('generating'), 'success');
            
            // Page dimensions in mm (landscape)
            const sizes = {
                a4: { width: 297, height: 210 },
                a3: { width: 420, height: 297 }
            };
            const page = sizes[format];
            const pageAspect = page.width / page.height;
            
            try {
                // Capture at high resolution
                const section = document.getElementById('timeline-section');
                const canvas = await html2canvas(section, { 
                    scale: 2, 
                    backgroundColor: darkMode ? '#0F172A' : '#FAFBFC',
                    logging: false
                });
                
                const imgAspect = canvas.width / canvas.height;
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ 
                    orientation: 'landscape', 
                    unit: 'mm', 
                    format: format 
                });
                
                let imgWidth, imgHeight, x, y;
                
                // Fit image to page while maintaining aspect ratio
                if (imgAspect > pageAspect) {
                    // Image is wider - fit to width
                    imgWidth = page.width - 20; // 10mm margin each side
                    imgHeight = imgWidth / imgAspect;
                    x = 10;
                    y = (page.height - imgHeight) / 2;
                } else {
                    // Image is taller - fit to height
                    imgHeight = page.height - 20; // 10mm margin each side
                    imgWidth = imgHeight * imgAspect;
                    x = (page.width - imgWidth) / 2;
                    y = 10;
                }
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, imgWidth, imgHeight);
                pdf.save(`Timeline-${currentYear1}-${currentYear2}-${format.toUpperCase()}.pdf`);
                showToast(t('downloadComplete'), 'success');
            } catch (e) { 
                console.error(e);
                showToast('PDF failed', 'error'); 
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const s = await res.json();
                document.getElementById('last-sync').textContent = s.lastFetch ? `${t('synced')}: ${new Date(s.lastFetch).toLocaleString()}` : t('neverSynced');
            } catch {}
        }

        function renderEventsList(type) {
            const list = document.getElementById(`${type}-list`), count = document.getElementById(`${type}-count`);
            let evts = filters[type] ? getVisibleEvents(type).filter(matchesSearch) : [];
            count.textContent = `${evts.length} ${t('events')}`;
            if (!evts.length) { list.innerHTML = `<div class="events-list-empty">${t('noEvents')}</div>`; return; }
            evts.sort((a,b) => a.startDate.localeCompare(b.startDate));
            const locale = currentLang === 'de' ? 'de-CH' : 'en-US';
            list.innerHTML = evts.map(e => {
                const sd = new Date(e.startDate+'T12:00:00');
                let dateStr = sd.toLocaleDateString(locale, { month:'short', day:'numeric', year:'numeric' });
                if (e.endDate && e.endDate !== e.startDate) dateStr += ' - ' + new Date(e.endDate+'T12:00:00').toLocaleDateString(locale, { month:'short', day:'numeric' });
                return `<div class="events-list-item" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${type}")'><span class="events-list-name">${e.name}</span><span class="events-list-date">${dateStr}</span></div>`;
            }).join('');
        }

        function getPositionForDate(s, year) {
            const d = new Date(s+'T12:00:00');
            if (d.getFullYear() !== year) return null;
            const start = new Date(year, 0, 1);
            const dayOfYear = Math.floor((d - start) / (1000*60*60*24));
            const totalDays = ((year%4===0 && year%100!==0) || year%400===0) ? 366 : 365;
            return (dayOfYear / (totalDays-1)) * 100;
        }

        function renderMonthMarkers(id, year) {
            let html = '';
            const months = getMonthShort();
            for (let m=0; m<12; m++) {
                const pos = getPositionForDate(`${year}-${String(m+1).padStart(2,'0')}-01`, year);
                if (pos !== null) html += `<div class="month-marker" style="left:${pos}%"><div class="month-marker-line"></div><span class="month-marker-label">${months[m]}</span></div>`;
            }
            document.getElementById(id).innerHTML = html;
        }

        function renderTodayMarker(year) {
            const today = new Date();
            if (today.getFullYear() !== year) return '';
            const pos = getPositionForDate(formatDateStr(today), year);
            return pos !== null ? `<div class="today-marker" style="left:${pos}%"></div>` : '';
        }

        function renderTimelineEvents(eventsId, monthsId, emptyId, year) {
            const container = document.getElementById(eventsId);
            const emptyEl = document.getElementById(emptyId);
            renderMonthMarkers(monthsId, year);
            
            const primary = [], secondary = [], multiDay = [];
            const monthNames = getMonthNames();
            const monthShort = getMonthShort();
            
            ['blessthun','youth'].forEach(type => {
                if (!filters[type]) return;
                (events[type]||[]).forEach(e => {
                    if (!matchesSearch(e)) return;
                    const sd = e.startDate || e.date;
                    if (!sd || parseInt(sd.slice(0,4)) < MIN_YEAR) return;
                    
                    // Overnight events: show as dot on both start and end dates
                    if (e.isOvernight && e.endDate) {
                        const posStart = getPositionForDate(sd, year);
                        if (posStart !== null) {
                            const d = new Date(sd+'T12:00:00');
                            secondary.push({ ...e, type, position: posStart, month: monthNames[d.getMonth()], day: d.getDate(), displayDate: sd });
                        }
                        if (e.endDate !== sd) {
                            const posEnd = getPositionForDate(e.endDate, year);
                            if (posEnd !== null) {
                                const d = new Date(e.endDate+'T12:00:00');
                                secondary.push({ ...e, type, position: posEnd, month: monthNames[d.getMonth()], day: d.getDate(), displayDate: e.endDate });
                            }
                        }
                    } else if (e.isMultiDay && e.endDate) {
                        const sp = getPositionForDate(sd, year), ep = getPositionForDate(e.endDate, year);
                        if (sp !== null || ep !== null) {
                            const startD = new Date(sd+'T12:00:00'), endD = new Date(e.endDate+'T12:00:00');
                            multiDay.push({ ...e, type, startPosition: sp??0, endPosition: ep??100, dateDisplay: `${monthShort[startD.getMonth()]} ${startD.getDate()} - ${monthShort[endD.getMonth()]} ${endD.getDate()}` });
                        }
                    } else {
                        const pos = getPositionForDate(sd, year);
                        if (pos !== null) {
                            const d = new Date(sd+'T12:00:00');
                            const data = { ...e, type, position: pos, month: monthNames[d.getMonth()], day: d.getDate() };
                            (e.name === PRIMARY_EVENTS[type] ? primary : secondary).push(data);
                        }
                    }
                });
            });

            // Group events by date+name+type (merge same-name events on same day)
            function groupByDateNameType(evts) {
                const groups = {};
                evts.forEach(e => {
                    const dateKey = e.displayDate || e.startDate || e.date;
                    const key = `${dateKey}|${e.name}|${e.type}`;
                    if (!groups[key]) {
                        groups[key] = { ...e, occurrences: [e], dateKey };
                    } else {
                        groups[key].occurrences.push(e);
                    }
                });
                return Object.values(groups);
            }

            // Assign vertical offsets for different events on same day+type
            function assignVerticalOffsets(evts) {
                // Group by date+type
                const byDateType = {};
                evts.forEach(e => {
                    const key = `${e.dateKey || e.startDate || e.date}|${e.type}`;
                    if (!byDateType[key]) byDateType[key] = [];
                    byDateType[key].push(e);
                });
                
                // Assign offsets within each group
                Object.values(byDateType).forEach(group => {
                    group.forEach((e, i) => {
                        e.verticalOffset = i; // 0, 1, 2, etc.
                    });
                });
            }

            const groupedPrimary = groupByDateNameType(primary);
            const groupedSecondary = groupByDateNameType(secondary);
            
            assignVerticalOffsets(groupedPrimary);
            assignVerticalOffsets(groupedSecondary);

            emptyEl.style.display = (groupedPrimary.length || groupedSecondary.length || multiDay.length) ? 'none' : 'block';

            const assignOffsets = evts => {
                evts.sort((a,b) => a.startPosition - b.startPosition);
                evts.forEach((e,i) => {
                    e.offset = 0;
                    const center = (e.startPosition + e.endPosition) / 2;
                    for (let j=0; j<i; j++) {
                        if (Math.abs((evts[j].startPosition + evts[j].endPosition)/2 - center) < 12) e.offset = Math.min((evts[j].offset||0)+1, 2);
                    }
                });
            };
            assignOffsets(multiDay.filter(e => e.type==='blessthun'));
            assignOffsets(multiDay.filter(e => e.type==='youth'));

            let html = renderTodayMarker(year);
            const todayStr = formatDateStr(new Date());
            
            multiDay.forEach(e => {
                // Calculate actual width, with a small minimum (1% â‰ˆ 3-4 days)
                const rawWidth = e.endPosition - e.startPosition;
                const width = Math.max(rawWidth, 1);
                const center = e.startPosition + width/2;
                const isPast = (e.endDate || e.startDate) < todayStr;
                const pastClass = isPast ? ' past' : '';
                html += `<div class="multiday-pill ${e.type}${pastClass}" style="left:${e.startPosition}%;width:${width}%"></div>`;
                html += `<div class="multiday-label ${e.type}-type${e.offset?` offset-${e.offset}`:''}${pastClass}" style="left:${center}%" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${e.type}")'><div class="event-label"><span class="event-month">${e.dateDisplay}</span><span class="event-name">${e.name||'Event'}</span></div><div class="event-connector"></div></div>`;
            });
            
            groupedSecondary.forEach(e => {
                const isPast = (e.displayDate || e.startDate || e.date) < todayStr;
                const pastClass = isPast ? ' past' : '';
                const vOffset = e.verticalOffset || 0;
                const offsetStyle = vOffset > 0 ? ` v-offset-${Math.min(vOffset, 3)}` : '';
                const edgeClass = e.position < 8 ? ' tooltip-right' : e.position > 92 ? ' tooltip-left' : '';
                html += `<div class="secondary-event ${e.type}${pastClass}${offsetStyle}${edgeClass}" style="left:${e.position}%" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${e.type}")'><div class="event-square ${e.type}"></div><div class="event-tooltip">${e.month} ${e.day}: ${e.name||'Event'}</div></div>`;
            });
            
            groupedPrimary.forEach(e => {
                const isPast = (e.startDate || e.date) < todayStr;
                const pastClass = isPast ? ' past' : '';
                const vOffset = e.verticalOffset || 0;
                const offsetStyle = vOffset > 0 ? ` v-offset-${Math.min(vOffset, 3)}` : '';
                const edgeClass = e.position < 8 ? ' tooltip-right' : e.position > 92 ? ' tooltip-left' : '';
                html += `<div class="event-marker ${e.type}${pastClass}${offsetStyle}${edgeClass}" style="left:${e.position}%" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${e.type}")'><div class="event-tooltip">${e.month} ${e.day}: ${e.name||'Event'}</div><div class="event-dot ${e.type}"></div></div>`;
            });

            container.innerHTML = html;
        }

        function renderAllTimelines() {
            renderTimelineEvents('timeline1-events', 'timeline1-months', 'timeline1-empty', currentYear1);
            renderTimelineEvents('timeline2-events', 'timeline2-months', 'timeline2-empty', currentYear2);
            renderHolidays('holidays-1', currentYear1);
            renderHolidays('holidays-2', currentYear2);
        }

        function getAllEvents(type) {
            return (events[type]||[]).map(e => ({...e, type})).filter(e => e.startDate && parseInt(e.startDate.slice(0,4)) >= MIN_YEAR);
        }

        // Get only events visible on the current timelines
        function getVisibleEvents(type) {
            return getAllEvents(type).filter(e => {
                const startYear = parseInt(e.startDate.slice(0, 4));
                const endYear = e.endDate ? parseInt(e.endDate.slice(0, 4)) : startYear;
                // Event is visible if it overlaps with either displayed year
                return (startYear === currentYear1 || startYear === currentYear2 ||
                        endYear === currentYear1 || endYear === currentYear2 ||
                        (startYear < currentYear1 && endYear > currentYear1) ||
                        (startYear < currentYear2 && endYear > currentYear2));
            });
        }

        function openModal(e, type) {
            currentModalEvent = { ...e, type };
            document.getElementById('modal-title').textContent = e.name;
            const badge = document.getElementById('modal-badge');
            badge.textContent = type === 'blessthun' ? 'BlessThun' : 'Youth Revival';
            badge.className = `modal-badge ${type}`;
            
            // Date
            const sd = new Date((e.startDate||e.date)+'T12:00:00');
            let dateText = sd.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            if (e.endDate && e.endDate !== e.startDate && !e.isOvernight) dateText += ' - ' + new Date(e.endDate+'T12:00:00').toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
            document.getElementById('modal-date-text').textContent = dateText;
            
            // Time - handle multiple occurrences (same name, different times)
            const timeEl = document.getElementById('modal-time');
            const timeText = document.getElementById('modal-time-text');
            
            if (e.occurrences && e.occurrences.length > 1) {
                // Multiple times for same event
                const times = e.occurrences.map(occ => {
                    let t = occ.startTime || 'All day';
                    if (occ.endTime) t += ' â€“ ' + occ.endTime;
                    return t;
                }).join('  â€¢  ');
                timeText.textContent = times;
                timeEl.style.display = 'flex';
            } else if (e.startTime && !e.isAllDay) {
                let timeStr = e.startTime;
                if (e.endTime) timeStr += ' â€“ ' + e.endTime;
                timeText.textContent = timeStr;
                timeEl.style.display = 'flex';
            } else {
                timeEl.style.display = 'none';
            }
            
            // Location
            const locEl = document.getElementById('modal-location');
            const locText = document.getElementById('modal-location-text');
            let location = e.location;
            if (!location && e.occurrences) {
                location = e.occurrences.find(o => o.location)?.location;
            }
            if (location) {
                locText.textContent = location;
                locEl.style.display = 'flex';
            } else {
                locEl.style.display = 'none';
            }
            
            // Other events on same day (different names only)
            const sameDayEl = document.getElementById('modal-same-day');
            const sameDayList = document.getElementById('same-day-list');
            const eventDate = e.displayDate || e.startDate || e.date;
            const allEvents = [...getAllEvents('blessthun'), ...getAllEvents('youth')];
            const otherEvents = allEvents.filter(ev => 
                (ev.startDate === eventDate || ev.date === eventDate) && 
                ev.name !== e.name
            );
            
            // Deduplicate by name for display
            const uniqueOtherEvents = [];
            const seen = new Set();
            otherEvents.forEach(ev => {
                const key = `${ev.name}|${ev.type}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueOtherEvents.push(ev);
                }
            });
            
            if (uniqueOtherEvents.length > 0) {
                sameDayList.innerHTML = uniqueOtherEvents.map(ev => {
                    const evType = ev.type;
                    const timeStr = ev.startTime ? ev.startTime : 'All day';
                    return `<div class="same-day-item" onclick="openModal(${JSON.stringify(ev).replace(/"/g, '&quot;')}, '${evType}')">
                        <span class="same-day-dot ${evType}"></span>
                        <span class="same-day-name">${ev.name}</span>
                        <span class="same-day-time">${timeStr}</span>
                    </div>`;
                }).join('');
                sameDayEl.style.display = 'block';
            } else {
                sameDayEl.style.display = 'none';
            }
            
            document.getElementById('event-modal').classList.add('active');
        }

        function closeModal(ev) {
            if (ev && ev.target !== ev.currentTarget) return;
            document.getElementById('event-modal').classList.remove('active');
            currentModalEvent = null;
        }

        function addToCalendar() {
            if (!currentModalEvent) return;
            const e = currentModalEvent;
            const sd = (e.startDate||e.date).replace(/-/g,'');
            const ed = new Date(e.endDate||e.startDate); ed.setDate(ed.getDate()+1);
            const edStr = ed.toISOString().slice(0,10).replace(/-/g,'');
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nUID:${Date.now()}@timeline\nDTSTART;VALUE=DATE:${sd}\nDTEND;VALUE=DATE:${edStr}\nSUMMARY:${e.name}\nEND:VEVENT\nEND:VCALENDAR`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([ics], { type: 'text/calendar' }));
            a.download = `${e.name.replace(/[^a-zA-Z0-9]/g,'_')}.ics`;
            a.click();
            showToast(t('eventDownloaded'), 'success');
            closeModal();
        }

        // Progress bar
        function updateProgress() {
            const now = new Date();
            const year = now.getFullYear();
            const start = new Date(year, 0, 1);
            const end = new Date(year + 1, 0, 1);
            const progress = ((now - start) / (end - start)) * 100;
            
            document.getElementById('progress-fill').style.width = `${progress.toFixed(1)}%`;
            document.getElementById('progress-text').textContent = `${progress.toFixed(0)}% of ${year}`;
            document.getElementById('progress-label').textContent = `${year} Progress`;
        }

        // Statistics
        function updateStats() {
            const blessthunEvents = getVisibleEvents('blessthun');
            const youthEvents = getVisibleEvents('youth');
            const allEvents = [...blessthunEvents, ...youthEvents];
            const now = new Date();
            const todayStr = formatDateStr(now);
            
            // Count upcoming (use endDate for multi-day, so ongoing events count)
            const upcoming = allEvents.filter(e => (e.endDate || e.startDate) >= todayStr).length;
            
            // Find busiest month (count each event once, by startDate month)
            const monthCounts = {};
            allEvents.forEach(e => {
                const month = e.startDate.slice(0, 7);
                monthCounts[month] = (monthCounts[month] || 0) + 1;
            });
            
            let busiestMonth = '-';
            let maxCount = 0;
            const monthShort = getMonthShort();
            Object.entries(monthCounts).forEach(([month, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    const [y, m] = month.split('-');
                    busiestMonth = monthShort[parseInt(m) - 1];
                }
            });
            
            document.getElementById('stat-blessthun').textContent = blessthunEvents.length;
            document.getElementById('stat-youth').textContent = youthEvents.length;
            document.getElementById('stat-upcoming').textContent = upcoming;
            document.getElementById('stat-busiest').textContent = busiestMonth;
        }

        // Jump to today
        function jumpToToday() {
            const now = new Date();
            const year = now.getFullYear();
            
            // Update year selects to current year
            if (currentYear1 !== year) {
                currentYear1 = year;
                document.getElementById('year1-select').value = year;
                document.getElementById('year1-badge').textContent = year;
            }
            
            renderAllTimelines();
            
            // Scroll to today marker
            setTimeout(() => {
                const todayMarker = document.querySelector('.today-marker');
                if (todayMarker) {
                    todayMarker.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    showToast(t('jumpedToToday'), 'success');
                }
            }, 100);
        }

        // Share functions
        function toggleShareMenu() {
            const menu = document.getElementById('share-menu');
            menu.classList.toggle('show');
            if (menu.classList.contains('show')) {
                generateQR();
            }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.pdf-dropdown')) {
                document.getElementById('pdf-menu')?.classList.remove('show');
                document.getElementById('share-menu')?.classList.remove('show');
            }
        });

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            showToast(t('linkCopied'), 'success');
            document.getElementById('share-menu').classList.remove('show');
        }

        function shareWhatsApp() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://wa.me/?text=Check%20out%20this%20event%20timeline:%20${url}`, '_blank');
        }

        function shareTelegram() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://t.me/share/url?url=${url}&text=Event%20Timeline`, '_blank');
        }

        // Simple QR code generator
        function generateQR() {
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            const url = window.location.href;
            
            // Use a simple QR API
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 120, 120);
                ctx.drawImage(img, 0, 0, 120, 120);
            };
            img.src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(url)}`;
        }

        // Check if date is in the past
        function isPastDate(dateStr) {
            const today = formatDateStr(new Date());
            return dateStr < today;
        }

        async function loadData() {
            await Promise.all([fetchCalendar('blessthun'), fetchCalendar('youth'), fetchHolidays()]);
            renderEventsList('blessthun');
            renderEventsList('youth');
            renderAllTimelines();
            updateCountdown();
            updateProgress();
            updateStats();
        }

        async function fetchHolidays() {
            try {
                const res = await fetch(`/calendars/holidays.ics?t=${Date.now()}`);
                if (!res.ok) return;
                const text = await res.text();
                if (!text.includes('BEGIN:VCALENDAR')) return;
                holidays = parseIcal(text);
                console.log('Holidays loaded:', holidays.length);
            } catch (e) {
                console.log('Holidays not available:', e);
            }
        }

        function renderHolidays(containerId, year) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const todayStr = formatDateStr(new Date());
            const yearHolidays = holidays.filter(h => {
                // Filter out Ramadan
                if (h.name && h.name.toLowerCase().includes('ramadan')) return false;
                
                // Only multi-day events (>=2 days)
                const startDate = h.startDate || h.date;
                const endDate = h.endDate || startDate;
                const start = new Date(startDate + 'T12:00:00');
                const end = new Date(endDate + 'T12:00:00');
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                if (days < 2) return false;
                
                // Check if in this year
                const startYear = parseInt(startDate.slice(0, 4));
                const endYear = parseInt(endDate.slice(0, 4));
                return startYear === year || endYear === year || (startYear < year && endYear > year);
            });

            if (!yearHolidays.length) {
                container.innerHTML = '';
                return;
            }

            // Calculate positions and width for each holiday
            const holidaysWithPos = yearHolidays.map(h => {
                const startDate = h.startDate || h.date;
                const endDate = h.endDate || startDate;
                let startPos = getPositionForDate(startDate, year);
                let endPos = getPositionForDate(endDate, year);
                if (startPos === null && endPos !== null) startPos = 0;
                if (endPos === null && startPos !== null) endPos = 100;
                const width = (endPos || 0) - (startPos || 0);
                return { ...h, startPos, endPos, startDate, endDate, width };
            }).filter(h => h.startPos !== null || h.endPos !== null);

            // Sort by width descending - longest holidays first
            holidaysWithPos.sort((a, b) => b.width - a.width);

            // Assign rows: longest goes to row 0 (center), others stack above
            // Row 0 = on the line, row 1/2/3 = above the line
            const rows = []; // rows[n] = array of holidays in that row
            
            holidaysWithPos.forEach(h => {
                // Try to find a row where this holiday doesn't overlap
                let assignedRow = -1;
                for (let row = 0; row <= 3; row++) {
                    if (!rows[row]) rows[row] = [];
                    
                    // Check if this holiday overlaps with any holiday in this row
                    const hasOverlap = rows[row].some(other => 
                        !(h.endPos <= other.startPos || h.startPos >= other.endPos)
                    );
                    
                    if (!hasOverlap) {
                        assignedRow = row;
                        rows[row].push(h);
                        break;
                    }
                }
                
                h.row = assignedRow >= 0 ? assignedRow : 3; // Default to row 3 if all full
            });

            // Generate HTML
            let html = '';
            const locale = currentLang === 'de' ? 'de-CH' : 'en-US';
            holidaysWithPos.forEach(h => {
                const width = Math.max(h.width, 1);
                const isPast = h.endDate < todayStr;
                const pastClass = isPast ? ' past' : '';
                const rowClass = h.row > 0 ? ` row-${h.row}` : '';
                
                // Format dates for tooltip
                const startD = new Date(h.startDate + 'T12:00:00');
                const endD = new Date(h.endDate + 'T12:00:00');
                const startStr = startD.toLocaleDateString(locale, { day: 'numeric', month: 'short' });
                const endStr = endD.toLocaleDateString(locale, { day: 'numeric', month: 'short', year: 'numeric' });
                const dateRange = `${startStr} â€“ ${endStr}`;

                html += `<div class="holiday-strip${pastClass}${rowClass}" style="left:${h.startPos}%;width:${width}%">
                    <span class="holiday-strip-label">${h.name}</span>
                    <div class="holiday-strip-tooltip">
                        <div>${h.name}</div>
                        <div class="tooltip-dates">${dateRange}</div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>
