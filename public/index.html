<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Timeline</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --salmon: #FA8072;
            --salmon-light: #FFF0EE;
            --salmon-dark: #E05A4C;
            --mint: #3EB489;
            --mint-light: #E8F8F2;
            --mint-dark: #2D9B74;
            --bg: #FAFBFC;
            --card-bg: #FFFFFF;
            --text-primary: #1A1A2E;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            --today: #3B82F6;
        }

        [data-theme="dark"] {
            --bg: #0F172A;
            --card-bg: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #334155;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            --salmon-light: rgba(250, 128, 114, 0.25);
            --mint-light: rgba(62, 180, 137, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Countdown Banner */
        .countdown-banner {
            background: linear-gradient(135deg, var(--salmon), var(--mint));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1.5rem auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            animation: fadeInUp 0.5s ease;
        }

        .countdown-banner.youth-next {
            background: linear-gradient(135deg, var(--mint), var(--mint-dark));
        }

        .countdown-banner.blessthun-next {
            background: linear-gradient(135deg, var(--salmon), var(--salmon-dark));
        }

        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .countdown-event {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.25rem 0;
        }

        .countdown-time {
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* Controls */
        .controls-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .legend {
            display: flex;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background: var(--border);
        }

        .legend-item.disabled {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.blessthun { background: var(--salmon); }
        .legend-dot.youth { background: var(--mint); }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 0.5rem 1rem 0.5rem 2rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.85rem;
            width: 160px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--salmon);
            width: 200px;
        }

        .search-icon {
            position: absolute;
            left: 0.6rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 14px;
            height: 14px;
        }

        .year-picker {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .year-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .btn {
            background: #1E293B;
            color: white;
            border: none;
            padding: 0.5rem 0.9rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: #059669; }
        .btn-success:hover { background: #047857; }

        .btn-icon {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            width: 34px;
            height: 34px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .btn-icon:hover {
            background: var(--border);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #D1D5DB;
            display: inline-block;
            margin-right: 0.25rem;
        }

        .status-dot.loaded { background: #10B981; }
        .status-dot.error { background: #EF4444; }

        /* Timeline */
        .timeline-section {
            margin-bottom: 2rem;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }

        .pdf-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pdf-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .pdf-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .timeline-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.5s ease;
            transition: all 0.3s ease;
        }

        .timeline-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .timeline-scroll-container::-webkit-scrollbar {
            height: 6px;
        }

        .timeline-scroll-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .timeline-content {
            min-width: 1000px;
        }

        @media (max-width: 700px) {
            .timeline-card { padding: 1rem; }
            .timeline-content { min-width: 900px; }
            .container { padding: 1rem; }
            body { padding: 1rem; }
            h1 { font-size: 1.8rem; }
            .controls-bar { gap: 0.5rem; }
            .search-input { width: 120px; }
            .search-input:focus { width: 150px; }
        }

        .timeline-header {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .year-badge {
            background: linear-gradient(135deg, var(--text-primary), #374151);
            color: white;
            padding: 0.4rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
        }

        [data-theme="dark"] .year-badge {
            background: linear-gradient(135deg, #475569, #334155);
        }

        .timeline-wrapper {
            position: relative;
            padding: 100px 0;
        }

        .timeline-track {
            position: relative;
            margin: 0 30px;
        }

        .timeline-line {
            height: 4px;
            background: linear-gradient(90deg, var(--salmon), var(--mint));
            border-radius: 2px;
            position: relative;
        }

        .timeline-dot-start, .timeline-dot-end {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .timeline-dot-start {
            left: -5px;
            background: var(--salmon);
        }

        .timeline-dot-end {
            right: -5px;
            background: var(--mint);
        }

        .timeline-empty {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem;
        }

        /* Today Marker */
        .today-marker {
            position: absolute;
            top: -25px;
            bottom: -25px;
            width: 2px;
            background: var(--today);
            z-index: 20;
            transform: translateX(-50%);
        }

        .today-marker::before {
            content: 'TODAY';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--today);
            color: white;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .today-marker::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--today);
            border-radius: 50%;
        }

        /* Month Markers */
        .month-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
        }

        .month-marker {
            position: absolute;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            top: 100%;
            margin-top: 6px;
        }

        .month-marker-line {
            width: 1px;
            height: 10px;
            background: var(--border);
        }

        .month-marker-label {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 3px;
        }

        /* Events */
        .events-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
        }

        .event-marker {
            position: absolute;
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s ease;
        }

        .event-marker:hover {
            transform: translateX(-50%) scale(1.2);
            z-index: 100;
        }

        .event-marker.blessthun {
            top: 50%;
            transform: translate(-50%, -100%);
            margin-top: -4px;
        }

        .event-marker.blessthun:hover {
            transform: translate(-50%, -100%) scale(1.2);
        }

        .event-marker.youth {
            top: 50%;
            margin-top: 4px;
        }

        .event-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .event-dot.blessthun { background: var(--salmon); }
        .event-dot.youth { background: var(--mint); }

        .event-tooltip {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .event-marker.blessthun .event-tooltip { bottom: 100%; margin-bottom: 6px; }
        .event-marker.youth .event-tooltip { top: 100%; margin-top: 6px; }
        .event-marker:hover .event-tooltip { opacity: 1; }

        /* Secondary Events */
        .secondary-event {
            position: absolute;
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: pointer;
            z-index: 8;
            transition: transform 0.2s ease;
        }

        .secondary-event:hover {
            z-index: 100;
            transform: translateX(-50%) scale(1.3);
        }

        .secondary-event.blessthun {
            top: 50%;
            transform: translate(-50%, -100%);
            margin-top: -2px;
        }

        .secondary-event.blessthun:hover {
            transform: translate(-50%, -100%) scale(1.3);
        }

        .secondary-event.youth {
            top: 50%;
            margin-top: 2px;
        }

        .event-square {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            opacity: 0.7;
        }

        .event-square.blessthun { background: var(--salmon); }
        .event-square.youth { background: var(--mint); }

        .secondary-event .event-tooltip {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .secondary-event.blessthun .event-tooltip { bottom: 100%; margin-bottom: 6px; }
        .secondary-event.youth .event-tooltip { top: 100%; margin-top: 6px; }
        .secondary-event:hover .event-tooltip { opacity: 1; }

        /* Multi-day */
        .multiday-pill {
            position: absolute;
            height: 8px;
            border-radius: 4px;
            z-index: 11;
            pointer-events: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        .multiday-pill.blessthun {
            background: var(--salmon);
            top: 50%;
            transform: translateY(-15px);
        }

        .multiday-pill.youth {
            background: var(--mint);
            top: 50%;
            transform: translateY(7px);
        }

        .multiday-label {
            position: absolute;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            cursor: pointer;
            z-index: 15;
            transition: transform 0.2s ease;
        }

        .multiday-label:hover {
            z-index: 100;
            transform: translateX(-50%) scale(1.05);
        }

        .multiday-label.blessthun-type {
            bottom: 50%;
            margin-bottom: 12px;
        }

        .multiday-label.youth-type {
            top: 50%;
            margin-top: 12px;
            flex-direction: column-reverse;
        }

        .multiday-label .event-connector {
            width: 2px;
            height: 22px;
            flex-shrink: 0;
        }

        .multiday-label.blessthun-type .event-connector { background: var(--salmon); }
        .multiday-label.youth-type .event-connector { background: var(--mint); }

        .multiday-label .event-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 8px;
            border-radius: 6px;
            max-width: 110px;
            transition: all 0.2s ease;
        }

        .multiday-label.blessthun-type .event-label {
            background: var(--salmon-light);
            border-left: 3px solid var(--salmon);
        }

        .multiday-label.youth-type .event-label {
            background: var(--mint-light);
            border-left: 3px solid var(--mint);
        }

        .multiday-label .event-month {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .multiday-label.blessthun-type .event-month { color: var(--salmon-dark); }
        .multiday-label.youth-type .event-month { color: var(--mint-dark); }

        .multiday-label .event-name {
            font-size: 0.65rem;
            font-weight: 500;
            color: #1A1A2E;
            text-align: center;
            word-wrap: break-word;
            max-width: 95px;
        }

        [data-theme="dark"] .multiday-label .event-name {
            color: #F1F5F9;
        }

        .multiday-label:hover .event-label {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .multiday-label.blessthun-type.offset-1 .event-connector { height: 50px; }
        .multiday-label.blessthun-type.offset-2 .event-connector { height: 78px; }
        .multiday-label.youth-type.offset-1 .event-connector { height: 50px; }
        .multiday-label.youth-type.offset-2 .event-connector { height: 78px; }

        /* Lists */
        .lists-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 700px) {
            .lists-wrapper { grid-template-columns: 1fr; }
        }

        .list-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeInUp 0.5s ease;
            transition: all 0.3s ease;
        }

        .list-card.blessthun { border-top: 4px solid var(--salmon); }
        .list-card.youth { border-top: 4px solid var(--mint); }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .list-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .event-count {
            background: var(--border);
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .events-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .events-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.4rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 4px;
            margin: 0 -0.4rem;
        }

        .events-list-item:hover { background: var(--border); }
        .events-list-item:last-child { border-bottom: none; }

        .events-list-name {
            font-weight: 500;
            font-size: 0.85rem;
        }

        .events-list-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .events-list-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 1rem;
            font-size: 0.85rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .modal-badge.blessthun {
            background: var(--salmon-light);
            color: var(--salmon-dark);
        }

        .modal-badge.youth {
            background: var(--mint-light);
            color: var(--mint-dark);
        }

        .modal-date {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .modal-actions .btn {
            flex: 1;
            justify-content: center;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #1E293B;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            font-size: 0.85rem;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { background: #059669; }
        .toast.error { background: #DC2626; }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spin { animation: spin 1s linear infinite; }

        /* Notification prompt */
        .notification-prompt {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin: 1rem auto;
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            animation: fadeInUp 0.5s ease;
            font-size: 0.85rem;
        }

        .notification-prompt.hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Event Timeline</h1>
            <p class="subtitle">Two-Year Overview</p>
            
            <div id="countdown-banner" class="countdown-banner" style="display: none;">
                <div class="countdown-label">Next Event</div>
                <div class="countdown-event" id="countdown-event"></div>
                <div class="countdown-time" id="countdown-time"></div>
            </div>
        </header>

        <div id="notification-prompt" class="notification-prompt hidden">
            <span>ðŸ”” Get notified before events?</span>
            <div style="display: flex; gap: 0.4rem;">
                <button class="btn" onclick="requestNotifications()">Enable</button>
                <button class="btn-icon" onclick="dismissNotifications()">âœ•</button>
            </div>
        </div>

        <div class="controls-bar">
            <div class="legend">
                <div class="legend-item" id="filter-blessthun" onclick="toggleFilter('blessthun')">
                    <div class="legend-dot blessthun"></div>
                    <span>BlessThun</span>
                </div>
                <div class="legend-item" id="filter-youth" onclick="toggleFilter('youth')">
                    <div class="legend-dot youth"></div>
                    <span>Youth Revival</span>
                </div>
            </div>

            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" placeholder="Search..." oninput="handleSearch(this.value)">
            </div>

            <div class="year-picker">
                <select class="year-select" id="year1-select" onchange="changeYear(1, this.value)"></select>
                <span style="color: var(--text-secondary);">&</span>
                <select class="year-select" id="year2-select" onchange="changeYear(2, this.value)"></select>
            </div>

            <button class="btn" id="resync-btn" onclick="manualResync()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Sync
            </button>

            <button class="btn btn-success" onclick="downloadPDF()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                PDF
            </button>

            <button class="btn-icon" onclick="toggleDarkMode()" title="Toggle dark mode">
                <svg id="theme-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </button>
        </div>

        <div class="status-bar">
            <span><span class="status-dot" id="blessthun-status"></span>BlessThun</span>
            <span><span class="status-dot" id="youth-status"></span>Youth Revival</span>
            <span id="last-sync"></span>
        </div>

        <div class="timeline-section" id="timeline-section">
            <div class="pdf-header">
                <h2 class="pdf-title">Event Timeline</h2>
                <div class="pdf-legend">
                    <span class="pdf-legend-item"><span class="legend-dot blessthun"></span> BlessThun</span>
                    <span class="pdf-legend-item"><span class="legend-dot youth"></span> Youth Revival</span>
                </div>
            </div>
            
            <div class="timeline-card">
                <div class="timeline-header">
                    <span class="year-badge" id="year1-badge">2026</span>
                </div>
                <div class="timeline-scroll-container">
                    <div class="timeline-content">
                        <div class="timeline-wrapper">
                            <div class="timeline-track">
                                <div class="timeline-line">
                                    <div class="timeline-dot-start"></div>
                                    <div class="timeline-dot-end"></div>
                                </div>
                                <div class="month-markers" id="timeline1-months"></div>
                                <div class="events-container" id="timeline1-events"></div>
                            </div>
                            <div class="timeline-empty" id="timeline1-empty">No events for this year</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="timeline-card">
                <div class="timeline-header">
                    <span class="year-badge" id="year2-badge">2027</span>
                </div>
                <div class="timeline-scroll-container">
                    <div class="timeline-content">
                        <div class="timeline-wrapper">
                            <div class="timeline-track">
                                <div class="timeline-line">
                                    <div class="timeline-dot-start"></div>
                                    <div class="timeline-dot-end"></div>
                                </div>
                                <div class="month-markers" id="timeline2-months"></div>
                                <div class="events-container" id="timeline2-events"></div>
                            </div>
                            <div class="timeline-empty" id="timeline2-empty">No events for this year</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lists-wrapper">
            <div class="list-card blessthun">
                <div class="list-header">
                    <h3 class="list-title">BlessThun Events</h3>
                    <span class="event-count" id="blessthun-count">0 events</span>
                </div>
                <div class="events-list" id="blessthun-list">
                    <div class="events-list-empty">Loading...</div>
                </div>
            </div>

            <div class="list-card youth">
                <div class="list-header">
                    <h3 class="list-title">Youth Revival Events</h3>
                    <span class="event-count" id="youth-count">0 events</span>
                </div>
                <div class="events-list" id="youth-list">
                    <div class="events-list-empty">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="event-modal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Event Name</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <span class="modal-badge" id="modal-badge">BlessThun</span>
            <div class="modal-date" id="modal-date">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span id="modal-date-text">January 15, 2026</span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="addToCalendar()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Add to Calendar
                </button>
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const MIN_YEAR = 2026;
        const YEAR_RANGE = [2025, 2026, 2027, 2028, 2029, 2030];
        const PRIMARY_EVENTS = { 'blessthun': 'BlessThun', 'youth': 'Youth Revival' };
        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const monthShort = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        let events = { blessthun: [], youth: [] };
        let currentYear1 = new Date().getFullYear();
        let currentYear2 = currentYear1 + 1;
        let filters = { blessthun: true, youth: true };
        let searchQuery = '';
        let currentModalEvent = null;
        let darkMode = localStorage.getItem('darkMode') === 'true';

        document.addEventListener('DOMContentLoaded', () => {
            initYearPickers();
            loadData();
            updateStatus();
            initDarkMode();
            checkNotificationPermission();
            setInterval(updateCountdown, 60000);
        });

        function initDarkMode() {
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : '');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            icon.innerHTML = darkMode 
                ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>'
                : '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
        }

        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default' && !localStorage.getItem('notificationsDismissed')) {
                document.getElementById('notification-prompt').classList.remove('hidden');
            }
        }

        function requestNotifications() {
            Notification.requestPermission().then(p => {
                document.getElementById('notification-prompt').classList.add('hidden');
                if (p === 'granted') showToast('Notifications enabled!', 'success');
            });
        }

        function dismissNotifications() {
            localStorage.setItem('notificationsDismissed', 'true');
            document.getElementById('notification-prompt').classList.add('hidden');
        }

        function initYearPickers() {
            const s1 = document.getElementById('year1-select'), s2 = document.getElementById('year2-select');
            YEAR_RANGE.forEach(y => {
                s1.innerHTML += `<option value="${y}" ${y===currentYear1?'selected':''}>${y}</option>`;
                s2.innerHTML += `<option value="${y}" ${y===currentYear2?'selected':''}>${y}</option>`;
            });
        }

        function changeYear(t, y) {
            y = parseInt(y);
            if (t===1) { currentYear1=y; document.getElementById('year1-badge').textContent=y; }
            else { currentYear2=y; document.getElementById('year2-badge').textContent=y; }
            renderAllTimelines();
        }

        function toggleFilter(type) {
            filters[type] = !filters[type];
            document.getElementById(`filter-${type}`).classList.toggle('disabled', !filters[type]);
            renderAllTimelines();
            renderEventsList('blessthun');
            renderEventsList('youth');
        }

        function handleSearch(q) {
            searchQuery = q.toLowerCase();
            renderAllTimelines();
            renderEventsList('blessthun');
            renderEventsList('youth');
        }

        function matchesSearch(e) { return !searchQuery || e.name.toLowerCase().includes(searchQuery); }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function updateCountdown() {
            const all = [...getAllEvents('blessthun'), ...getAllEvents('youth')];
            const now = new Date();
            const upcoming = all.filter(e => new Date(e.startDate+'T00:00:00') > now).sort((a,b) => a.startDate.localeCompare(b.startDate))[0];
            const banner = document.getElementById('countdown-banner');
            
            if (!upcoming) { banner.style.display = 'none'; return; }
            
            const eventDate = new Date(upcoming.startDate+'T00:00:00');
            const diffDays = Math.ceil((eventDate - now) / (1000*60*60*24));
            
            banner.style.display = 'block';
            banner.className = `countdown-banner ${upcoming.type}-next`;
            document.getElementById('countdown-event').textContent = upcoming.name;
            document.getElementById('countdown-time').textContent = diffDays === 0 ? 'Today!' : diffDays === 1 ? 'Tomorrow!' : `In ${diffDays} days`;
        }

        function parseICalDate(s) {
            if (!s) return null;
            if (s.length === 8) return new Date(parseInt(s.slice(0,4)), parseInt(s.slice(4,6))-1, parseInt(s.slice(6,8)), 12);
            if (s.includes('T')) {
                const isUTC = s.endsWith('Z');
                const c = s.replace('Z','');
                const d = new Date(parseInt(c.slice(0,4)), parseInt(c.slice(4,6))-1, parseInt(c.slice(6,8)), parseInt(c.slice(9,11))||0, parseInt(c.slice(11,13))||0);
                if (isUTC) return new Date(new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes())).toLocaleString('en-US',{timeZone:'Europe/Zurich'}));
                return d;
            }
            return new Date(s);
        }

        function formatDateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

        function parseIcal(data) {
            const evts = [], lines = data.split(/\r?\n/);
            let cur = null;
            for (let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                while (i+1<lines.length && (lines[i+1].startsWith(' ')||lines[i+1].startsWith('\t'))) { i++; line += lines[i].slice(1); }
                if (line === 'BEGIN:VEVENT') cur = {};
                else if (line === 'END:VEVENT' && cur) {
                    if (cur.startDate && cur.name) {
                        let end = cur.endDate || cur.startDate;
                        if (cur.endIsAllDay && end !== cur.startDate) {
                            const ed = new Date(end+'T12:00:00'); ed.setDate(ed.getDate()-1); end = formatDateStr(ed);
                        }
                        evts.push({ id: Date.now()+Math.random(), date: cur.startDate, startDate: cur.startDate, endDate: end, name: cur.name, isMultiDay: end !== cur.startDate });
                    }
                    cur = null;
                } else if (cur) {
                    const ci = line.indexOf(':');
                    if (ci > 0) {
                        const key = line.slice(0,ci), val = line.slice(ci+1);
                        const isDateOnly = key.includes('VALUE=DATE') && !key.includes('DATE-TIME');
                        if (key.startsWith('DTSTART')) { const p = parseICalDate(val); if(p) { cur.startDate = formatDateStr(p); cur.startIsAllDay = isDateOnly || val.length===8; } }
                        else if (key.startsWith('DTEND')) { const p = parseICalDate(val); if(p) { cur.endDate = formatDateStr(p); cur.endIsAllDay = isDateOnly || val.length===8; } }
                        else if (key === 'SUMMARY') cur.name = val;
                    }
                }
            }
            return evts;
        }

        async function fetchCalendar(type) {
            const status = document.getElementById(`${type}-status`);
            try {
                const res = await fetch(`/calendars/${type}.ics?t=${Date.now()}`);
                if (!res.ok) throw new Error();
                const data = await res.text();
                if (!data.includes('BEGIN:VCALENDAR')) throw new Error();
                events[type] = parseIcal(data);
                status.classList.add('loaded'); status.classList.remove('error');
                return true;
            } catch { status.classList.add('error'); status.classList.remove('loaded'); events[type] = []; return false; }
        }

        async function manualResync() {
            const btn = document.getElementById('resync-btn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>';
            try {
                const res = await fetch('/api/resync', { method: 'POST' });
                const r = await res.json();
                if (r.success) { showToast('Synced!', 'success'); await loadData(); }
                else showToast('Sync failed', 'error');
            } catch (e) { showToast('Sync failed', 'error'); }
            btn.disabled = false;
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> Sync';
        }

        async function downloadPDF() {
            showToast('Generating PDF...', 'success');
            try {
                const canvas = await html2canvas(document.getElementById('timeline-section'), { scale: 2, backgroundColor: darkMode ? '#0F172A' : '#FAFBFC' });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a3' });
                const ratio = Math.min(420/canvas.width, 297/canvas.height);
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', (420-canvas.width*ratio)/2, (297-canvas.height*ratio)/2, canvas.width*ratio, canvas.height*ratio);
                pdf.save(`Timeline-${currentYear1}-${currentYear2}.pdf`);
                showToast('PDF downloaded!', 'success');
            } catch (e) { showToast('PDF failed', 'error'); }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const s = await res.json();
                document.getElementById('last-sync').textContent = s.lastFetch ? `Synced: ${new Date(s.lastFetch).toLocaleString()}` : 'Never synced';
            } catch {}
        }

        function renderEventsList(type) {
            const list = document.getElementById(`${type}-list`), count = document.getElementById(`${type}-count`);
            let evts = filters[type] ? getAllEvents(type).filter(matchesSearch) : [];
            count.textContent = `${evts.length} event${evts.length!==1?'s':''}`;
            if (!evts.length) { list.innerHTML = '<div class="events-list-empty">No events</div>'; return; }
            evts.sort((a,b) => a.startDate.localeCompare(b.startDate));
            list.innerHTML = evts.map(e => {
                const sd = new Date(e.startDate+'T12:00:00');
                let dateStr = sd.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
                if (e.endDate && e.endDate !== e.startDate) dateStr += ' - ' + new Date(e.endDate+'T12:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' });
                return `<div class="events-list-item" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${type}")'><span class="events-list-name">${e.name}</span><span class="events-list-date">${dateStr}</span></div>`;
            }).join('');
        }

        function getPositionForDate(s, year) {
            const d = new Date(s+'T12:00:00');
            if (d.getFullYear() !== year) return null;
            const start = new Date(year, 0, 1);
            const dayOfYear = Math.floor((d - start) / (1000*60*60*24));
            const totalDays = ((year%4===0 && year%100!==0) || year%400===0) ? 366 : 365;
            return (dayOfYear / (totalDays-1)) * 100;
        }

        function renderMonthMarkers(id, year) {
            let html = '';
            for (let m=0; m<12; m++) {
                const pos = getPositionForDate(`${year}-${String(m+1).padStart(2,'0')}-01`, year);
                if (pos !== null) html += `<div class="month-marker" style="left:${pos}%"><div class="month-marker-line"></div><span class="month-marker-label">${monthShort[m]}</span></div>`;
            }
            document.getElementById(id).innerHTML = html;
        }

        function renderTodayMarker(year) {
            const today = new Date();
            if (today.getFullYear() !== year) return '';
            const pos = getPositionForDate(formatDateStr(today), year);
            return pos !== null ? `<div class="today-marker" style="left:${pos}%"></div>` : '';
        }

        function renderTimelineEvents(eventsId, monthsId, emptyId, year) {
            const container = document.getElementById(eventsId);
            const emptyEl = document.getElementById(emptyId);
            renderMonthMarkers(monthsId, year);
            
            const primary = [], secondary = [], multiDay = [];
            
            ['blessthun','youth'].forEach(type => {
                if (!filters[type]) return;
                (events[type]||[]).forEach(e => {
                    if (!matchesSearch(e)) return;
                    const sd = e.startDate || e.date;
                    if (!sd || parseInt(sd.slice(0,4)) < MIN_YEAR) return;
                    
                    if (e.isMultiDay && e.endDate) {
                        const sp = getPositionForDate(sd, year), ep = getPositionForDate(e.endDate, year);
                        if (sp !== null || ep !== null) {
                            const startD = new Date(sd+'T12:00:00'), endD = new Date(e.endDate+'T12:00:00');
                            multiDay.push({ ...e, type, startPosition: sp??0, endPosition: ep??100, dateDisplay: `${monthShort[startD.getMonth()]} ${startD.getDate()} - ${monthShort[endD.getMonth()]} ${endD.getDate()}` });
                        }
                    } else {
                        const pos = getPositionForDate(sd, year);
                        if (pos !== null) {
                            const d = new Date(sd+'T12:00:00');
                            const data = { ...e, type, position: pos, month: monthNames[d.getMonth()], day: d.getDate() };
                            (e.name === PRIMARY_EVENTS[type] ? primary : secondary).push(data);
                        }
                    }
                });
            });

            emptyEl.style.display = (primary.length || secondary.length || multiDay.length) ? 'none' : 'block';

            const assignOffsets = evts => {
                evts.sort((a,b) => a.startPosition - b.startPosition);
                evts.forEach((e,i) => {
                    e.offset = 0;
                    const center = (e.startPosition + e.endPosition) / 2;
                    for (let j=0; j<i; j++) {
                        if (Math.abs((evts[j].startPosition + evts[j].endPosition)/2 - center) < 12) e.offset = Math.min((evts[j].offset||0)+1, 2);
                    }
                });
            };
            assignOffsets(multiDay.filter(e => e.type==='blessthun'));
            assignOffsets(multiDay.filter(e => e.type==='youth'));

            let html = renderTodayMarker(year);
            
            multiDay.forEach(e => {
                const width = Math.max(e.endPosition - e.startPosition, 3);
                const center = e.startPosition + width/2;
                html += `<div class="multiday-pill ${e.type}" style="left:${e.startPosition}%;width:${width}%"></div>`;
                html += `<div class="multiday-label ${e.type}-type${e.offset?` offset-${e.offset}`:''}" style="left:${center}%" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${e.type}")'><div class="event-label"><span class="event-month">${e.dateDisplay}</span><span class="event-name">${e.name||'Event'}</span></div><div class="event-connector"></div></div>`;
            });
            
            secondary.forEach(e => {
                html += `<div class="secondary-event ${e.type}" style="left:${e.position}%" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${e.type}")'><div class="event-tooltip">${e.month} ${e.day}: ${e.name||'Event'}</div><div class="event-square ${e.type}"></div></div>`;
            });
            
            primary.forEach(e => {
                html += `<div class="event-marker ${e.type}" style="left:${e.position}%" onclick='openModal(${JSON.stringify(e).replace(/'/g,"&#39;")}, "${e.type}")'><div class="event-tooltip">${e.month} ${e.day}: ${e.name||'Event'}</div><div class="event-dot ${e.type}"></div></div>`;
            });

            container.innerHTML = html;
        }

        function renderAllTimelines() {
            renderTimelineEvents('timeline1-events', 'timeline1-months', 'timeline1-empty', currentYear1);
            renderTimelineEvents('timeline2-events', 'timeline2-months', 'timeline2-empty', currentYear2);
        }

        function getAllEvents(type) {
            return (events[type]||[]).map(e => ({...e, type})).filter(e => e.startDate && parseInt(e.startDate.slice(0,4)) >= MIN_YEAR);
        }

        function openModal(e, type) {
            currentModalEvent = { ...e, type };
            document.getElementById('modal-title').textContent = e.name;
            const badge = document.getElementById('modal-badge');
            badge.textContent = type === 'blessthun' ? 'BlessThun' : 'Youth Revival';
            badge.className = `modal-badge ${type}`;
            const sd = new Date((e.startDate||e.date)+'T12:00:00');
            let dateText = sd.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            if (e.endDate && e.endDate !== e.startDate) dateText += ' - ' + new Date(e.endDate+'T12:00:00').toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
            document.getElementById('modal-date-text').textContent = dateText;
            document.getElementById('event-modal').classList.add('active');
        }

        function closeModal(ev) {
            if (ev && ev.target !== ev.currentTarget) return;
            document.getElementById('event-modal').classList.remove('active');
            currentModalEvent = null;
        }

        function addToCalendar() {
            if (!currentModalEvent) return;
            const e = currentModalEvent;
            const sd = (e.startDate||e.date).replace(/-/g,'');
            const ed = new Date(e.endDate||e.startDate); ed.setDate(ed.getDate()+1);
            const edStr = ed.toISOString().slice(0,10).replace(/-/g,'');
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nUID:${Date.now()}@timeline\nDTSTART;VALUE=DATE:${sd}\nDTEND;VALUE=DATE:${edStr}\nSUMMARY:${e.name}\nEND:VEVENT\nEND:VCALENDAR`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([ics], { type: 'text/calendar' }));
            a.download = `${e.name.replace(/[^a-zA-Z0-9]/g,'_')}.ics`;
            a.click();
            showToast('Event downloaded!', 'success');
            closeModal();
        }

        async function loadData() {
            await Promise.all([fetchCalendar('blessthun'), fetchCalendar('youth')]);
            renderEventsList('blessthun');
            renderEventsList('youth');
            renderAllTimelines();
            updateCountdown();
        }
    </script>
</body>
</html>
